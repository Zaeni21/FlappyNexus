<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flappy Nexus</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
  .stars {
    position: fixed;
    width: 100%;
    height: 100%;
    background: transparent url('https://cdn.pixabay.com/photo/2017/07/17/22/24/stars-2514311_1280.png') repeat;
    background-size: cover;
    animation: moveStars 60s linear infinite;
    z-index: 0;
  }

  @keyframes moveStars {
    from { background-position: 0 0; }
    to { background-position: -1000px 1000px; }
  }
</style>
  <style>
  @keyframes fly {
    0% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0); }
  }

  #hero-image {
    animation: fly 2s ease-in-out infinite;
  }
</style>
</head>
<body class="bg-black text-white min-h-screen font-sans relative overflow-hidden">
<div id="star-bg" class="stars absolute inset-0 z-0"></div>
<canvas id="starfield" class="fixed top-0 left-0 w-full h-full z-1"></canvas>
  
<!-- Wallet Connect -->
<div class="absolute top-4 right-4 z-50">
  <div id="walletDisplay" class="flex items-center space-x-2 bg-gray-900 px-3 py-1 rounded-full cursor-pointer">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2h14a2 2 0 002-2v-2.79M16 12h2" />
    </svg>
    <div id="wallet-status" class="w-4 h-4 bg-gray-500 rounded-full"></div>
    <span id="wallet-text" class="text-sm">Connect Wallet</span>
  </div>

  <div id="walletPopup" class="absolute right-0 mt-2 bg-gray-800 border border-gray-600 p-3 rounded hidden z-50">
    <p class="text-green-400 text-sm mb-2">Connected</p>
    <button onclick="disconnectWallet()" class="bg-red-600 hover:bg-red-700 px-2 py-1 text-xs rounded">Disconnect</button>
  </div>
</div>

<!-- Game UI -->
<div id="mode-selection" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center space-y-6 z-20">
  <h1 class="text-4xl font-extrabold text-white drop-shadow-md">Flappy Nexus</h1>

  <div class="grid grid-cols-2 gap-4 w-72 mx-auto">
    <button onclick="startOffchain()" class="bg-purple-600 hover:bg-purple-700 transition px-6 py-3 rounded-xl font-bold text-white shadow">Play Offchain</button>
    <button onclick="startOnchain()" class="bg-green-600 hover:bg-green-700 transition px-6 py-3 rounded-xl font-bold text-white shadow">Play Onchain</button>
    <button onclick="showLeaderboard()" class="bg-blue-600 hover:bg-blue-700 transition px-6 py-3 rounded-xl font-bold text-white shadow col-span-2">Leaderboard</button>
    <button onclick="mintNFT()" class="bg-yellow-500 hover:bg-yellow-600 transition px-6 py-3 rounded-xl font-bold text-white shadow col-span-2">Mint NFT</button>
  </div>

  <div id="score" class="text-lg font-semibold mt-2 text-white drop-shadow">Score: 0</div>

  <!-- Hero Image -->
  <div id="hero-image" class="pt-6 flex justify-center">
    <img src="https://ipfs.io/ipfs/bafybeielnggeoq3acfq2kpr7mm2ofkhovwppowxllfaev6ke47rwsde3k4" alt="Flappy Hero" class="w-36 md:w-48 rounded-xl shadow-xl" />
  </div>
</div>
<!-- Game Canvas -->
<canvas id="gameCanvas" class="absolute inset-0 w-full h-full z-2"></canvas>

<!-- Leaderboard -->
<div id="leaderboard-popup" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-900 p-6 rounded shadow-lg z-50 w-80">
  <h2 class="text-lg font-bold mb-4">Top Players</h2>
  <ul id="leaderboard-list" class="space-y-1 text-sm"></ul>

  <!-- Tombol distribusi khusus admin -->
  <div id="admin-distribute" class="mt-4 hidden">
    <button onclick="distributeRewardsFromContract()" class="bg-green-600 px-4 py-2 rounded font-bold ml-2">
      Distribusi Reward
    </button>
  </div>

  <button onclick="document.getElementById('leaderboard-popup').classList.add('hidden')" class="mt-4 bg-purple-700 px-3 py-1 rounded">
    Close
  </button>
</div>
  <!-- Tombol Stake mengambang kanan bawah -->
<a href="/Stake/index.html"
   class="fixed bottom-16 right-2 bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-2 rounded-full flex items-center gap-2 shadow-lg z-50">
  <!-- Ikon kecil -->
  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
      d="M12 8c-1.657 0-3 1.343-3 3v1H6v6h12v-6h-3v-1c0-1.657-1.343-3-3-3z" />
  </svg>
  Stake
</a>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let onchain = false;
let walletAddress = null;
let isConnected = false;

  let gameOver = false;
let hasSubmitted = false;
const contractAddress = "0xFeAEe9a44e45F4a8275BffCCC5E03b712aA407D0";
const abi = [
  {
    "inputs": [],
    "name": "distributeRewards",
    "outputs": [],
    "stateMutability": "payable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "getTopPlayers",
    "outputs": [{
      "components": [
        { "internalType": "address", "name": "addr", "type": "address" },
        { "internalType": "uint256", "name": "score", "type": "uint256" }
      ],
      "internalType": "struct FlappyScore.Player[]",
      "name": "",
      "type": "tuple[]"
    }],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      { "internalType": "uint256", "name": "score", "type": "uint256" },
      { "internalType": "uint8", "name": "v", "type": "uint8" },
      { "internalType": "bytes32", "name": "r", "type": "bytes32" },
      { "internalType": "bytes32", "name": "s", "type": "bytes32" }
    ],
    "name": "submitScore",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  }
];

const landakImg = new Image();
landakImg.src = "https://ipfs.io/ipfs/bafybeielnggeoq3acfq2kpr7mm2ofkhovwppowxllfaev6ke47rwsde3k4" bambooImg = new Image();
bambooImg.src = "https://gateway.pinata.cloud/ipfs/bafkreicbretqtvephhgmcr7rb57rjxxubbpkxie5bl7ycm5wciqf7bjlsi";

const bird = { x: 80, y: canvas.height / 2, width: 50, height: 50, velocity: 0, gravity: 0.06, lift: -2.2 };
let score = 0, frame = 0, pipes = [], pipeGap = 170, pipeWidth = 60;

function drawBird() {
  if (landakImg.complete) ctx.drawImage(landakImg, bird.x, bird.y, bird.width, bird.height);
}
function drawPipes() {
  pipes.forEach(p => {
    if (bambooImg.complete) {
      ctx.drawImage(bambooImg, p.x, 0, pipeWidth, p.top);
      ctx.drawImage(bambooImg, p.x, canvas.height - p.bottom, pipeWidth, p.bottom);
    }
  });
}
function update() {
  if (gameOver) return;
  
  frame++;
  bird.velocity += bird.gravity;
  bird.y += bird.velocity;
  if (frame % 150 === 0) {
    const top = Math.random() * (canvas.height - pipeGap - 200) + 50;
    const bottom = canvas.height - top - pipeGap;
    pipes.push({ x: canvas.width, top, bottom, padding: 10 });
  }
  pipes.forEach((p, i) => {
    p.x -= 1.2;
    if (p.x + pipeWidth < 0) {
      pipes.splice(i, 1);
      score++;
      document.getElementById("score").innerText = "Score: " + score;
    }
    if (bird.x < p.x + pipeWidth - p.padding &&
        bird.x + bird.width > p.x + p.padding &&
        (bird.y < p.top || bird.y + bird.height > canvas.height - p.bottom)) {
      showGameOver(score);
      return;
    }
  });
  if (bird.y + bird.height > canvas.height || bird.y < 0) {
    showGameOver(score);
    return;
  }
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawBird();
  drawPipes();
  requestAnimationFrame(update);
}
function showGameOver(score) {
  if (gameOver) return;
  gameOver = true;

  const overlay = document.createElement('div');
  overlay.id = "gameOverOverlay"; // kasih ID langsung ke elemen div
  overlay.innerHTML = `
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); display: flex; flex-direction: column;
      justify-content: center; align-items: center; color: white; font-family: sans-serif; z-index: 9999;">
      
      <h1 style="font-size: 2em; margin-bottom: 10px;">Game Over!</h1>
      <p style="font-size: 1.2em; margin-bottom: 20px;">Score: ${score}</p>

      <div class="flex space-x-4">
        <button onclick="restartGame()" style="padding: 10px 20px; background: #9333ea; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">
          Play Again
        </button>
        ${onchain ? `
        <button id="submitBtn" style="padding: 10px 20px; background: #22c55e; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">
          Submit Score
        </button>` : ''}
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  document.getElementById("bg-music").pause();

  if (onchain) {
    setTimeout(() => {
      const btn = document.getElementById("submitBtn");
      if (!btn) return;

      let hasSubmitted = false;
      btn.addEventListener("click", async () => {
        if (hasSubmitted) return;
        hasSubmitted = true;
        btn.disabled = true;
        btn.innerText = "Submitting...";
        try {
          await submitScoreOnchain(score);
          btn.innerText = "Submitted!";
          btn.style.background = "#16a34a";
        } catch (e) {
          btn.innerText = "Error!";
          btn.style.background = "#dc2626";
        }
      });
    }, 100);
  }
}
  function restartGame() {
  gameOver = false;
  hasSubmitted = false;
  score = 0;
  frame = 0;
  pipes = [];
  bird.y = canvas.height / 2;
  bird.velocity = 0;

  // Hapus overlay game over
  const overlay = document.getElementById("gameOverOverlay");
  if (overlay) overlay.remove();

  document.getElementById("score").innerText = "Score: 0";    
document.getElementById("bg-music").play().catch(e => {
  console.warn("Audio resume blocked:", e);
});
  update(); // Mulai ulang animasi game
}
function startOffchain() {
  onchain = false;
  document.getElementById("star-bg").style.display = "none";
  document.getElementById("starfield").style.display = "none";
  document.getElementById("mode-selection").style.display = "none";
  document.getElementById("hero-image").style.display = "none";
  document.getElementById("social-footer").style.display = "none";
  update();
  document.getElementById("bg-music").play().catch(e => {
  console.warn("Autoplay blocked, will play on next interaction");
});
}
  function startOnchain() {
  if (!isConnected) {
    alert("Connect wallet dulu bro!");
    return;
  }
    document.getElementById("star-bg").style.display = "none";
    document.getElementById("starfield").style.display = "none";
  document.getElementById("mode-selection").style.display = "none";
    document.getElementById("hero-image").style.display = "none";
    document.getElementById("social-footer").style.display = "none";
  update();
    document.getElementById("bg-music").play().catch(e => {
  console.warn("Autoplay blocked, will play on next interaction");
});
}
  document.getElementById("walletDisplay").addEventListener("click", async () => {
  if (!isConnected) {
    await connectWallet();
  } else {
    document.getElementById("walletPopup").classList.toggle("hidden");
  }
});
async function connectWallet() {
  if (!window.ethereum || (!window.okxwallet && !window.ethereum.isConnected())) {
  alert("Tidak ada wallet terdeteksi. Install OKX Wallet atau MetaMask dulu bro!");
  return;
}

  try {
    await ethereum.request({
      method: 'wallet_addEthereumChain',
      params: [{
        chainId: '0xf64',
        chainName: 'Nexus Tesnet',
        rpcUrls: ['https://nexus-testnet.g.alchemy.com/public'],
        nativeCurrency: { name: 'NEX Token', symbol: 'NEX', decimals: 18 },
        blockExplorerUrls: ['https://testnet3.explorer.nexus.xyz']
      }]
    });
    const provider = new ethers.providers.Web3Provider(window.ethereum);
await provider.send("eth_requestAccounts", []);
walletAddress = await provider.getSigner().getAddress();
onchain = true;
isConnected = true;
updateWalletStatus(true);

document.getElementById("wallet-text").textContent = walletAddress.slice(0, 6) + "..." + walletAddress.slice(-3);
document.getElementById("wallet-status").classList.remove("bg-gray-500");
document.getElementById("wallet-status").classList.add("bg-blue-500");

document.getElementById("walletPopup").classList.remove("hidden");

alert("Wallet connected! Klik Play Onchain untuk mulai game.");
  } catch (err) {
    console.error(err);
    alert("Gagal connect wallet");
  }
}
async function submitScoreOnchain(score) {
  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const signer = provider.getSigner();
    const address = await signer.getAddress();

    const hash = ethers.utils.solidityKeccak256(["address", "uint256"], [address, score]);
    const arrayified = ethers.utils.arrayify(hash);
    const signature = await signer.signMessage(arrayified);
    const { v, r, s } = ethers.utils.splitSignature(signature);

    const contract = new ethers.Contract(contractAddress, abi, signer);
    await contract.submitScore(score, v, r, s);
    alert("Score submitted successfully!");
  } catch (err) {
    alert("Submit failed: " + err.message);
  }
}
async function showLeaderboard() {
  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const signer = provider.getSigner();
    const userAddress = await signer.getAddress();
    const contract = new ethers.Contract(contractAddress, abi, provider);

    const players = await contract.getTopPlayers();
    console.log("Top players:", players); // Debug ini
    const ul = document.getElementById("leaderboard-list");
    ul.innerHTML = "";

    players.forEach((player, index) => {
      const li = document.createElement("li");
      const shortAddr = player.addr.slice(0, 6) + "..." + player.addr.slice(-4);
      li.innerHTML = `${index + 1}. ${shortAddr} - ${player.score}`;
      if (player.addr.toLowerCase() === userAddress.toLowerCase()) {
        li.style.color = "#22d3ee";
        li.style.fontWeight = "bold";
      }
      ul.appendChild(li);
    });

    document.getElementById("leaderboard-popup").classList.remove("hidden");
    
    if (userAddress.toLowerCase() === "0x58c5796edc7001b949693cc2655d190db54c271f") {
      document.getElementById("admin-distribute").classList.remove("hidden");
    }
  }catch (err) {
    console.error("Leaderboard error:", err); // Tambahkan ini
    alert("Gagal ambil leaderboard!");
  }
}
  async function distributeRewardsFromContract() {
  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const signer = provider.getSigner();
    const user = await signer.getAddress();

    const contract = new ethers.Contract(contractAddress, abi, signer);
const wallet = await signer.getAddress();

// Ganti ini ke address admin lo (0x58...271F)
const admin = "0x58c5796edc7001b949693cc2655D190db54c271F";

if (wallet.toLowerCase() !== admin.toLowerCase()) {
  return alert("Only admin can distribute rewards.");
}

const tx = await contract.distributeRewards({ value: ethers.utils.parseEther("5") });
await tx.wait();

    alert("Rewards distributed!");
  } catch (err) {
    console.error("Gagal distribusi:", err);
    alert("Distribusi gagal: " + err.message);
  }
}
async function mintNFT() {
  if (!isConnected) {
    alert("Connect wallet dulu bro!");
    return;
  }

  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const signer = provider.getSigner();
    const contract = new ethers.Contract(
      "0xAA66da7322Aa663EFC4594C4825eB82E8D400021", // alamat kontrak Flappy NFT
      ["function mint() public"],
      signer
    );

    const tx = await contract.mint();
    await tx.wait();
    alert("NFT sukses dimint!");
  } catch (err) {
    console.error(err);
    alert("Minting gagal: " + err.message);
  }
}
window.addEventListener("keydown", e => { if (e.code === "Space") bird.velocity = bird.lift; });
window.addEventListener("touchstart", () => bird.velocity = bird.lift);
window.addEventListener("resize", () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});

function disconnectWallet() {
  isConnected = false;
  walletAddress = null;
  updateWalletStatus(false);
  document.getElementById("walletPopup").classList.add("hidden");
  document.getElementById("wallet-text").textContent = "Connect Wallet";
  document.getElementById("wallet-status").classList.remove("bg-blue-500");
  document.getElementById("wallet-status").classList.add("bg-gray-500");
}
  function updateWalletStatus(connected) {
  if (connected) {
    document.getElementById("wallet-status").classList.remove("bg-gray-500");
    document.getElementById("wallet-status").classList.add("bg-blue-500");
    document.getElementById("wallet-text").textContent = walletAddress.slice(0, 6) + "..." + walletAddress.slice(-3);
  } else {
    document.getElementById("wallet-status").classList.remove("bg-blue-500");
    document.getElementById("wallet-status").classList.add("bg-gray-500");
    document.getElementById("wallet-text").textContent = "Connect Wallet";
  }
}
</script>
  <footer>
  <!-- Footer Teks Kiri Bawah -->
<div class="fixed bottom-2 left-4 text-gray-500" style="font-size: 5px;">
  © 2025 Built by JAWIRNFT with passion for degen culture
</div>

<!-- Ikon kanan bawah -->
<div id="social-footer" class="fixed bottom-2 right-4 flex items-center space-x-3 text-white">
  <!-- Twitter -->
  <a href="https://twitter.com/0xzvan" target="_blank" class="hover:text-purple-400">
    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5" viewBox="0 0 24 24">
      <path d="M18.244 3h2.852l-6.225 7.1 7.34 10.9h-5.748l-4.126-6.175L6.716 21H3.857l6.651-7.582L3 3h5.82l3.705 5.62L18.244 3Zm-.992 17h1.578L8.72 4H7.086l10.166 16Z"/>
    </svg>
  </a>
  <!-- Instagram -->
  <a href="https://instagram.com/0xzvan" target="_blank" class="hover:text-pink-400">
    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5" viewBox="0 0 24 24">
      <path d="M7.5 2h9A5.5 5.5 0 0 1 22 7.5v9a5.5 5.5 0 0 1-5.5 5.5h-9A5.5 5.5 0 0 1 2 16.5v-9A5.5 5.5 0 0 1 7.5 2Zm9 1.5h-9A4 4 0 0 0 3.5 7.5v9A4 4 0 0 0 7.5 20.5h9a4 4 0 0 0 4-4v-9a4 4 0 0 0-4-4Zm-4.5 3.25a5.25 5.25 0 1 1 0 10.5a5.25 5.25 0 0 1 0-10.5Zm0 1.5a3.75 3.75 0 1 0 0 7.5a3.75 3.75 0 0 0 0-7.5Zm4.63-.63a.75.75 0 1 1 1.5 0a.75.75 0 0 1-1.5 0Z"/>
    </svg>
  </a>
</div>
</footer>
  <audio id="bg-music" src="https://aqua-glad-tern-369.mypinata.cloud/ipfs/bafybeifokiywb2vpbbuwifddxxyr6kxft7bo4j3isoojfdgox7v6tcer7q" autoplay loop hidden></audio>
  <script>
  const canvasStar = document.getElementById('starfield');
  const ctxStar = canvasStar.getContext('2d');
  canvasStar.width = window.innerWidth;
  canvasStar.height = window.innerHeight;

  const stars = Array.from({ length: 100 }, () => ({
    x: Math.random() * canvasStar.width,
    y: Math.random() * canvasStar.height,
    radius: Math.random() * 1.5,
    speed: Math.random() * 0.5 + 0.2
  }));

  function drawStars() {
    ctxStar.clearRect(0, 0, canvasStar.width, canvasStar.height);
    ctxStar.fillStyle = 'white';
    stars.forEach(star => {
      ctxStar.beginPath();
      ctxStar.arc(star.x, star.y, star.radius, 0, 2 * Math.PI);
      ctxStar.fill();
      star.y += star.speed;
      if (star.y > canvasStar.height) {
        star.y = 0;
        star.x = Math.random() * canvasStar.width;
      }
    });
    requestAnimationFrame(drawStars);
  }

  drawStars();
  window.addEventListener('resize', () => {
    canvasStar.width = window.innerWidth;
    canvasStar.height = window.innerHeight;
  });
</script>
</body>
</html>
